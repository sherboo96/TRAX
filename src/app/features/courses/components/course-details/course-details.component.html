<div *ngIf="course" class="min-h-screen bg-gray-50">
  <!-- Course Header -->
  <div class="bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <!-- Breadcrumb -->
      <nav class="flex mb-6" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
          <li class="inline-flex items-center">
            <a
              routerLink="/admin/courses"
              class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600 transition-colors"
            >
              <i class="fas fa-arrow-left mr-2"></i>
              Back to Courses
            </a>
          </li>
        </ol>
      </nav>

      <!-- Course Title and Basic Info -->
      <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
        <div class="xl:col-span-2">
          <h1 class="text-3xl font-bold text-gray-900 mb-4">
            {{ course.title }}
          </h1>
          <p class="text-lg text-gray-600 mb-6 leading-relaxed">
            {{ course.description }}
          </p>

          <!-- Course Meta -->
          <div
            class="flex flex-wrap items-center gap-4 text-sm text-gray-600 mb-6"
          >
            <div class="flex items-center">
              <ng-container
                *ngIf="course.instructors && course.instructors.length > 0"
              >
                <ng-container
                  *ngFor="let instructor of course.instructors; let i = index"
                >
                  <span class="flex items-center mr-2" *ngIf="i < 2">
                    <ng-container *ngIf="instructor.photoUrl; else avatar">
                      <img
                        [src]="imageBaseUrl + instructor.photoUrl"
                        [alt]="instructor.nameEn"
                        class="w-8 h-8 rounded-full object-cover border border-gray-200 shadow-sm mr-2"
                      />
                    </ng-container>
                    <ng-template #avatar>
                      <span
                        class="w-8 h-8 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center font-bold text-base border border-gray-200 shadow-sm mr-2"
                      >
                        {{ instructor.nameEn.charAt(0) }}
                      </span>
                    </ng-template>
                    <span class="text-sm">{{ instructor.nameEn }}</span>
                  </span>
                </ng-container>
                <span
                  *ngIf="course.instructors.length > 2"
                  class="text-xs text-gray-500 ml-2"
                  >+{{ course.instructors.length - 2 }} more</span
                >
              </ng-container>
            </div>
            <div class="flex items-center">
              <i class="fas fa-star text-yellow-400 mr-1"></i>
              <span class="font-medium">{{ course.kpiWeight }}</span>
              <span class="ml-1">({{ course.availableSeats }} students)</span>
            </div>
            <div class="flex items-center">
              <i class="fas fa-clock mr-2 text-green-500"></i>
              <span>{{ course.duration }}</span>
            </div>
            <div class="flex items-center">
              <i class="fas fa-calendar mr-2 text-purple-500"></i>
              <span>Updated {{ course.lastUpdated }}</span>
            </div>
          </div>

          <!-- Course Badges -->
          <div class="flex flex-wrap gap-2 mb-6">
            <span
              [class]="getLevelColor(course.level)"
              class="px-3 py-1 rounded-full text-sm font-medium"
            >
              {{ getLevelText(course.level) }}
            </span>
            <span
              [class]="getStatusColor(course.statusId)"
              class="px-3 py-1 rounded-full text-sm font-medium"
            >
              {{ course.statusName }}
            </span>
            <span
              class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-medium"
            >
              {{ course.language }}
            </span>
            <span
              *ngIf="course.certificate"
              class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium"
            >
              <i class="fas fa-certificate mr-1"></i>
              Certificate
            </span>
            <span
              *ngIf="course.statusId === 2 && course.registerationClosedAt"
              [class]="
                getRegisterationClosedAtColor() +
                ' px-3 py-1 rounded-full text-sm font-medium'
              "
            >
              Registration Closes:
              {{ course.registerationClosedAt | date : "mediumDate" }}
            </span>
          </div>
        </div>

        <!-- Course Image and Actions -->
        <div class="xl:col-span-1">
          <!-- Course Action Buttons -->
          <div class="flex flex-row gap-2 mb-6">
            <!-- Edit Button -->
            <button
              *ngIf="currentUser?.userType === 1"
              (click)="editCourse()"
              class="flex-1 inline-flex items-center justify-center px-3 py-2 border border-gray-300 shadow-sm text-xs font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200"
            >
              <i class="fas fa-edit mr-1"></i>
              Edit
            </button>

            <!-- Publish/Unpublish Button -->
            <button
              *ngIf="!isCoursePublished() && currentUser?.userType === 1"
              (click)="publishCourse()"
              class="flex-1 inline-flex items-center justify-center px-3 py-2 border border-green-600 shadow-sm text-xs font-medium rounded-lg text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-200"
            >
              <i class="fas fa-eye mr-1"></i>
              Publish
            </button>

            <button
              *ngIf="isCoursePublished() && currentUser?.userType === 1"
              (click)="unpublishCourse()"
              class="flex-1 inline-flex items-center justify-center px-3 py-2 border border-gray-600 shadow-sm text-xs font-medium rounded-lg text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all duration-200"
            >
              <i class="fas fa-eye-slash mr-1"></i>
              Unpublish
            </button>

            <!-- Make Active Button -->
            <button
              *ngIf="canMakeActive() && currentUser?.userType === 1"
              (click)="makeActive()"
              class="flex-1 inline-flex items-center justify-center px-3 py-2 border border-blue-600 shadow-sm text-xs font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200"
            >
              <i class="fas fa-play mr-1"></i>
              Make Active
            </button>

            <!-- Show Attendance QR Button -->
            <button
              *ngIf="currentUser?.userType === 1"
              (click)="showAttendanceQR()"
              class="flex-1 inline-flex items-center justify-center px-3 py-2 border border-purple-600 shadow-sm text-xs font-medium rounded-lg text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-all duration-200"
            >
              <i class="fas fa-qrcode mr-1"></i>
              Show Attendance QR
            </button>

            <!-- Show Course QR Button -->
            <button
              *ngIf="currentUser?.userType === 1"
              (click)="showCourseQR()"
              class="flex-1 inline-flex items-center justify-center px-3 py-2 border border-indigo-600 shadow-sm text-xs font-medium rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200"
            >
              <i class="fas fa-qrcode mr-1"></i>
              Show Course QR
            </button>

            <!-- Archive Button -->
            <button
              *ngIf="!isCourseArchived() && currentUser?.userType === 1"
              (click)="archiveCourse()"
              class="flex-1 inline-flex items-center justify-center px-3 py-2 border border-orange-600 shadow-sm text-xs font-medium rounded-lg text-white bg-orange-600 hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition-all duration-200"
            >
              <i class="fas fa-archive mr-1"></i>
              Archive
            </button>
          </div>

          <!-- Course Image -->
          <div class="relative">
            <img
              [src]="imageBaseUrl + course.image"
              [alt]="course.title"
              class="w-full h-64 object-cover rounded-xl shadow-md"
            />
            <div
              class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent rounded-xl"
            ></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
      <!-- Left Column - Course Content -->
      <div class="xl:col-span-3">
        <!-- Navigation Tabs -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-8">
          <nav class="flex overflow-x-auto">
            <button
              (click)="setActiveTab('overview')"
              [class]="
                activeTab === 'overview'
                  ? 'border-blue-500 text-blue-600 bg-blue-50'
                  : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'
              "
              class="whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition-all duration-200 flex-shrink-0"
            >
              <i class="fas fa-info-circle mr-2"></i>
              Overview
            </button>
            <button
              (click)="setActiveTab('curriculum')"
              [class]="
                activeTab === 'curriculum'
                  ? 'border-blue-500 text-blue-600 bg-blue-50'
                  : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'
              "
              class="whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition-all duration-200 flex-shrink-0"
              *ngIf="currentUser?.userType === 1"
            >
              <i class="fas fa-book mr-2"></i>
              Curriculum
            </button>
            <button
              (click)="setActiveTab('instructor')"
              [class]="
                activeTab === 'instructor'
                  ? 'border-blue-500 text-blue-600 bg-blue-50'
                  : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'
              "
              class="whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition-all duration-200 flex-shrink-0"
            >
              <i class="fas fa-chalkboard-teacher mr-2"></i>
              Instructor
            </button>
            <button
              (click)="setActiveTab('enrollments')"
              [class]="
                activeTab === 'enrollments'
                  ? 'border-blue-500 text-blue-600 bg-blue-50'
                  : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'
              "
              class="whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition-all duration-200 flex-shrink-0"
              *ngIf="currentUser?.userType === 1"
            >
              <i class="fas fa-users mr-2"></i>
              Enrollments
            </button>
            <button
              (click)="setActiveTab('attendees')"
              [class]="
                activeTab === 'attendees'
                  ? 'border-blue-500 text-blue-600 bg-blue-50'
                  : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'
              "
              class="whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition-all duration-200 flex-shrink-0"
              *ngIf="currentUser?.userType === 1"
            >
              <i class="fas fa-user-check mr-2"></i>
              Attendees
            </button>
          </nav>
        </div>

        <!-- Tab Content -->
        <div
          class="bg-white rounded-xl shadow-sm border border-gray-200 min-h-96"
        >
          <div class="p-8">
            <!-- Overview Tab -->
            <div *ngIf="activeTab === 'overview'" class="space-y-8">
              <!-- What you'll learn -->
              <div>
                <h3
                  class="text-xl font-semibold text-gray-900 mb-6 flex items-center"
                >
                  <i class="fas fa-graduation-cap text-blue-500 mr-3"></i>
                  What you'll learn
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div
                    *ngFor="let outcome of course.learningOutcomes"
                    class="flex items-start p-3 bg-gray-50 rounded-lg"
                  >
                    <i
                      class="fas fa-check text-green-500 mt-1 mr-3 flex-shrink-0"
                    ></i>
                    <span class="text-gray-700">{{ outcome }}</span>
                  </div>
                </div>
              </div>

              <!-- Requirements -->
              <div>
                <h3
                  class="text-xl font-semibold text-gray-900 mb-6 flex items-center"
                >
                  <i class="fas fa-list-check text-purple-500 mr-3"></i>
                  Requirements
                </h3>
                <ul class="space-y-3">
                  <li
                    *ngFor="let requirement of course.requirements"
                    class="flex items-start p-3 bg-gray-50 rounded-lg"
                  >
                    <i
                      class="fas fa-arrow-right text-blue-500 mt-1 mr-3 flex-shrink-0"
                    ></i>
                    <span class="text-gray-700">{{ requirement }}</span>
                  </li>
                </ul>
              </div>

              <!-- Course Description -->
              <div>
                <h3
                  class="text-xl font-semibold text-gray-900 mb-6 flex items-center"
                >
                  <i class="fas fa-file-text text-green-500 mr-3"></i>
                  Description
                </h3>
                <div
                  class="prose max-w-none text-gray-700 bg-gray-50 p-6 rounded-lg"
                >
                  <p class="leading-relaxed">{{ course.description }}</p>
                </div>
              </div>
            </div>

            <!-- Curriculum Tab -->
            <div
              *ngIf="activeTab === 'curriculum' && currentUser?.userType === 1"
              class="space-y-6"
            >
              <div class="flex items-center justify-between mb-6">
                <h3
                  class="text-xl font-semibold text-gray-900 flex items-center"
                >
                  <i class="fas fa-book text-blue-500 mr-3"></i>
                  Course Content
                </h3>
                <div
                  class="text-sm text-gray-600 bg-gray-100 px-3 py-1 rounded-full"
                >
                  {{ getTotalResources() }} resources ‚Ä¢
                  {{ getTotalDuration() }} total length
                </div>
              </div>

              <!-- Course Modules -->
              <div class="space-y-4">
                <div
                  *ngFor="let module of getVisibleModules()"
                  class="border border-gray-200 rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow duration-200"
                >
                  <!-- Module Header -->
                  <div
                    class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b border-gray-200"
                  >
                    <div class="flex items-center justify-between">
                      <div class="flex items-center space-x-4">
                        <i class="fas fa-play-circle text-blue-500 text-xl"></i>
                        <div>
                          <h4 class="font-semibold text-gray-900 text-lg">
                            {{ module.title }}
                          </h4>
                          <p class="text-sm text-gray-600 mt-1">
                            {{ module.description }}
                          </p>
                        </div>
                      </div>
                      <div class="flex items-center space-x-4">
                        <span
                          class="text-sm text-gray-500 bg-white px-2 py-1 rounded-full"
                        >
                          <i class="fas fa-clock mr-1"></i>
                          {{ module.duration }}
                        </span>
                        <span
                          class="text-sm text-gray-500 bg-white px-2 py-1 rounded-full"
                        >
                          <i class="fas fa-file mr-1"></i>
                          {{ module.resources.length }} resources
                        </span>
                        <i
                          [class]="
                            module.isCompleted
                              ? 'fas fa-check-circle text-green-500 text-xl'
                              : 'fas fa-circle text-gray-300 text-xl'
                          "
                        ></i>
                      </div>
                    </div>
                  </div>

                  <!-- Module Resources -->
                  <div class="p-6">
                    <div class="space-y-3">
                      <div
                        *ngFor="let resource of module.resources"
                        class="flex items-center justify-between p-4 rounded-lg border cursor-pointer hover:bg-gray-50 transition-all duration-200"
                        [class]="
                          getResourceBgColor(resource.type) +
                          ' ' +
                          getResourceBorderColor(resource.type)
                        "
                        (click)="playResource(resource)"
                      >
                        <div class="flex items-center space-x-4">
                          <i
                            [class]="
                              getResourceIcon(resource.type) +
                              ' ' +
                              getResourceColor(resource.type) +
                              ' text-xl'
                            "
                          ></i>
                          <div>
                            <h5 class="font-semibold text-gray-900">
                              {{ resource.title }}
                            </h5>
                            <p class="text-sm text-gray-600 mt-1">
                              {{ resource.description }}
                            </p>
                          </div>
                        </div>
                        <div class="flex items-center space-x-4">
                          <span
                            class="text-sm text-gray-500 bg-white px-2 py-1 rounded-full"
                          >
                            {{
                              resource.type === "video"
                                ? resource.duration
                                : resource.size
                            }}
                          </span>
                          <i
                            [class]="
                              resource.isCompleted
                                ? 'fas fa-check-circle text-green-500 text-xl'
                                : 'fas fa-circle text-gray-300 text-xl'
                            "
                          ></i>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Show More/Less Button -->
                <div
                  *ngIf="course.learningOutcomes.length > 3"
                  class="text-center pt-4"
                >
                  <button
                    (click)="toggleModules()"
                    class="text-blue-600 hover:text-blue-700 font-medium bg-blue-50 hover:bg-blue-100 px-6 py-2 rounded-lg transition-all duration-200"
                  >
                    <i
                      class="fas fa-chevron-down mr-2"
                      *ngIf="!showAllModules"
                    ></i>
                    <i
                      class="fas fa-chevron-up mr-2"
                      *ngIf="showAllModules"
                    ></i>
                    {{ showAllModules ? "Show Less" : "Show More" }}
                  </button>
                </div>
              </div>
            </div>

            <!-- Instructor Tab -->
            <div *ngIf="activeTab === 'instructor'" class="space-y-6">
              <h3
                class="text-xl font-semibold text-gray-900 mb-6 flex items-center"
              >
                <i class="fas fa-chalkboard-teacher text-blue-500 mr-3"></i>
                About the Instructor
              </h3>
              <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                <div class="flex items-start space-x-6">
                  <ng-container
                    *ngIf="course.instructors && course.instructors.length > 0"
                  >
                    <ng-container
                      *ngFor="
                        let instructor of course.instructors;
                        let i = index
                      "
                    >
                      <span class="flex items-start mr-6" *ngIf="i < 2">
                        <ng-container
                          *ngIf="instructor.photoUrl; else avatarInstructor"
                        >
                          <img
                            [src]="imageBaseUrl + instructor.photoUrl"
                            [alt]="instructor.nameEn"
                            class="w-20 h-20 rounded-full object-cover border border-gray-200 shadow-sm mr-4"
                          />
                        </ng-container>
                        <ng-template #avatarInstructor>
                          <span
                            class="w-20 h-20 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center font-bold text-3xl border border-gray-200 shadow-sm mr-4"
                          >
                            {{ instructor.nameEn.charAt(0) }}
                          </span>
                        </ng-template>
                        <div class="flex-1">
                          <h4 class="text-xl font-semibold text-gray-900 mb-2">
                            {{ instructor.nameEn }}
                          </h4>
                          <p class="text-gray-600 mb-4 leading-relaxed">
                            {{ instructor.bio }}
                          </p>
                          <div
                            class="flex items-center space-x-6 text-sm text-gray-500"
                          >
                            <span class="flex items-center">
                              <i class="fas fa-users mr-2"></i>
                              {{ course.availableSeats }} students
                            </span>
                            <span class="flex items-center">
                              <i class="fas fa-star mr-2"></i>
                              {{ course.kpiWeight }} rating
                            </span>
                            <span class="flex items-center">
                              <i class="fas fa-play-circle mr-2"></i>
                              {{ getTotalResources() }} courses
                            </span>
                          </div>
                        </div>
                      </span>
                    </ng-container>
                    <span
                      *ngIf="course.instructors.length > 2"
                      class="text-xs text-gray-500 ml-2"
                      >+{{ course.instructors.length - 2 }} more</span
                    >
                  </ng-container>
                </div>
              </div>
            </div>

            <!-- Enrollments Tab -->
            <div
              *ngIf="activeTab === 'enrollments' && currentUser?.userType === 1"
              class="space-y-6"
            >
              <div class="flex items-center justify-between mb-6">
                <h3
                  class="text-xl font-semibold text-gray-900 flex items-center"
                >
                  <i class="fas fa-users text-blue-500 mr-3"></i>
                  Course Enrollments
                </h3>
                <div
                  class="text-sm text-gray-600 bg-blue-50 px-3 py-1 rounded-full flex items-center gap-2"
                >
                  {{ enrollments.length }} total enrollments
                  <button
                    (click)="loadEnrollments()"
                    [disabled]="enrollmentsLoading"
                    class="ml-2 px-2 py-1 rounded-full border border-blue-300 bg-white text-blue-600 hover:bg-blue-100 transition-all duration-200 text-xs font-medium flex items-center"
                    title="Refresh Enrollments"
                  >
                    <i
                      class="fas fa-sync-alt"
                      [class.animate-spin]="enrollmentsLoading"
                    ></i>
                    <span class="ml-1">Refresh</span>
                  </button>
                </div>
              </div>

              <div
                class="bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm"
              >
                <div class="overflow-x-auto">
                  <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                      <tr>
                        <th
                          class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                        >
                          Student
                        </th>
                        <th
                          class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                        >
                          Enrollment Date
                        </th>
                        <th
                          class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                        >
                          Status
                        </th>
                        <th
                          class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                        >
                          Actions
                        </th>
                      </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                      <tr
                        *ngFor="let enrollment of enrollments"
                        class="hover:bg-gray-50 transition-colors"
                      >
                        <td class="px-6 py-4 whitespace-nowrap">
                          <div class="flex items-center">
                            <div
                              class="w-10 h-10 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center text-white font-semibold text-sm"
                            >
                              {{ enrollment.fullNameEn?.charAt(0) || "S" }}
                            </div>
                            <div class="ml-4">
                              <div class="text-sm font-medium text-gray-900">
                                {{
                                  getFirstThreeNamesCapitalized(
                                    enrollment.fullNameEn
                                  )
                                }}
                              </div>
                              <div class="text-sm text-gray-500">
                                {{ enrollment.email }}
                              </div>
                            </div>
                          </div>
                        </td>
                        <td
                          class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"
                        >
                          {{ enrollment.registeredAt | date : "mediumDate" }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                          <span
                            [class]="
                              enrollment.registerationStatusId === 1
                                ? 'bg-yellow-100 text-yellow-800'
                                : enrollment.registerationStatusId === 2
                                ? 'bg-green-100 text-green-800'
                                : 'bg-red-100 text-red-800'
                            "
                            class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                          >
                            {{ enrollment.registerationStatusName }}
                          </span>
                        </td>
                        <td
                          class="px-6 py-4 whitespace-nowrap text-sm font-medium"
                        >
                          <div class="flex items-center gap-2">
                            <button
                              *ngIf="enrollment.registerationStatusId === 1"
                              (click)="approveEnrollment(enrollment.userId)"
                              class="text-green-600 hover:text-green-900 bg-green-50 hover:bg-green-100 px-3 py-1 rounded-lg text-xs font-medium transition-all duration-200"
                            >
                              <i class="fas fa-check mr-1"></i>
                              Approve
                            </button>
                            <button
                              *ngIf="enrollment.registerationStatusId === 1"
                              (click)="rejectEnrollment(enrollment.userId)"
                              class="text-red-600 hover:text-red-900 bg-red-50 hover:bg-red-100 px-3 py-1 rounded-lg text-xs font-medium transition-all duration-200"
                            >
                              <i class="fas fa-times mr-1"></i>
                              Reject
                            </button>
                            <button
                              *ngIf="enrollment.registerationStatusId !== 1"
                              (click)="viewEnrollmentDetails(enrollment.userId)"
                              class="text-blue-600 hover:text-blue-900 bg-blue-50 hover:bg-blue-100 px-3 py-1 rounded-lg text-xs font-medium transition-all duration-200"
                            >
                              <i class="fas fa-eye mr-1"></i>
                              View
                            </button>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Attendees Tab -->
            <div
              *ngIf="activeTab === 'attendees' && currentUser?.userType === 1"
              class="space-y-6"
            >
              <div class="flex items-center justify-between mb-6">
                <h3
                  class="text-xl font-semibold text-gray-900 flex items-center"
                >
                  <i class="fas fa-user-check text-blue-500 mr-3"></i>
                  Course Attendance
                </h3>
                <div class="flex items-center gap-4">
                  <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700"
                      >Date:</label
                    >
                    <input
                      type="date"
                      [(ngModel)]="selectedAttendanceDate"
                      (ngModelChange)="onAttendanceDateChange()"
                      class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    />
                  </div>
                  <div
                    class="text-sm text-gray-600 bg-blue-50 px-3 py-1 rounded-full flex items-center gap-2"
                  >
                    {{ attendances.length }} of
                    {{ attendanceTotalCount }} attendees
                    <button
                      (click)="loadAttendances()"
                      [disabled]="attendancesLoading"
                      class="ml-2 px-2 py-1 rounded-full border border-blue-300 bg-white text-blue-600 hover:bg-blue-100 transition-all duration-200 text-xs font-medium flex items-center"
                      title="Refresh Attendance"
                    >
                      <i
                        class="fas fa-sync-alt"
                        [class.animate-spin]="attendancesLoading"
                      ></i>
                      <span class="ml-1">Refresh</span>
                    </button>
                  </div>
                </div>
              </div>

              <div
                class="bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm"
              >
                <div class="overflow-x-auto">
                  <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                      <tr>
                        <th
                          class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                        >
                          Student
                        </th>
                        <th
                          class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                        >
                          Check-in Time
                        </th>
                        <th
                          class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                        >
                          Check-out Time
                        </th>
                        <th
                          class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                        >
                          Duration
                        </th>
                      </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                      <tr
                        *ngFor="let attendance of attendances"
                        class="hover:bg-gray-50 transition-colors"
                      >
                        <td class="px-6 py-4 whitespace-nowrap">
                          <div class="flex items-center">
                            <div
                              class="w-10 h-10 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center text-white font-semibold text-sm"
                            >
                              {{ attendance.user.fullNameEn?.charAt(0) || "S" }}
                            </div>
                            <div class="ml-4">
                              <div class="text-sm font-medium text-gray-900">
                                {{
                                  getFirstThreeNamesCapitalized(
                                    attendance.user.fullNameEn
                                  )
                                }}
                              </div>
                              <div class="text-sm text-gray-500">
                                {{ attendance.user.email }}
                              </div>
                            </div>
                          </div>
                        </td>
                        <td
                          class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"
                        >
                          {{
                            attendance.attendence
                              ? (attendance.attendence | date : "shortTime")
                              : "Not checked in"
                          }}
                        </td>
                        <td
                          class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"
                        >
                          {{
                            attendance.leave
                              ? (attendance.leave | date : "shortTime")
                              : "Not checked out"
                          }}
                        </td>
                        <td
                          class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"
                        >
                          <span
                            *ngIf="attendance.attendence && attendance.leave"
                          >
                            {{
                              getAttendanceDuration(
                                attendance.attendence,
                                attendance.leave
                              )
                            }}
                          </span>
                          <span
                            *ngIf="!attendance.attendence || !attendance.leave"
                            class="text-gray-400"
                          >
                            -
                          </span>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <!-- Pagination -->
                <div
                  *ngIf="attendanceTotalCount > attendancePageSize"
                  class="bg-gray-50 px-6 py-3 border-t border-gray-200"
                >
                  <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-700">
                      Showing
                      {{ (attendancePage - 1) * attendancePageSize + 1 }} to
                      {{
                        Math.min(
                          attendancePage * attendancePageSize,
                          attendanceTotalCount
                        )
                      }}
                      of {{ attendanceTotalCount }} results
                    </div>
                    <div class="flex items-center space-x-2">
                      <button
                        (click)="onAttendancePageChange(attendancePage - 1)"
                        [disabled]="attendancePage <= 1"
                        class="px-3 py-1 text-sm border border-gray-300 rounded-md bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-blue-500"
                      >
                        Previous
                      </button>
                      <span class="text-sm text-gray-700">
                        Page {{ attendancePage }} of
                        {{
                          Math.ceil(attendanceTotalCount / attendancePageSize)
                        }}
                      </span>
                      <button
                        (click)="onAttendancePageChange(attendancePage + 1)"
                        [disabled]="
                          attendancePage >=
                          Math.ceil(attendanceTotalCount / attendancePageSize)
                        "
                        class="px-3 py-1 text-sm border border-gray-300 rounded-md bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-blue-500"
                      >
                        Next
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Empty State -->
              <div
                *ngIf="!attendancesLoading && attendances.length === 0"
                class="bg-gray-50 p-8 rounded-xl border border-gray-200 text-center"
              >
                <i class="fas fa-users text-4xl text-gray-400 mb-4"></i>
                <p class="text-gray-600 text-lg">
                  No attendance records found for this date.
                </p>
                <p class="text-gray-500 text-sm mt-2">
                  Try selecting a different date or check back later.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column - Course Card -->
      <div class="xl:col-span-1">
        <div class="sticky top-8">
          <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6">
            <h3
              class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2"
            >
              <span>üìã</span> Course Details
            </h3>
            <hr class="mb-6" />
            <ul class="space-y-4 text-sm text-gray-700">
              <li class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                <span class="text-lg">üìç</span>
                <span
                  ><span class="font-medium">Location:</span>
                  {{ course.location }}</span
                >
              </li>
              <li class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                <span class="text-lg">üóìÔ∏è</span>
                <span
                  ><span class="font-medium">Start:</span>
                  {{ course.startDate | date : "mediumDate" }}</span
                >
              </li>
              <li class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                <span class="text-lg">üóìÔ∏è</span>
                <span
                  ><span class="font-medium">End:</span>
                  {{ course.endDate | date : "mediumDate" }}</span
                >
              </li>
              <li class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                <span class="text-lg">‚è∞</span>
                <span
                  ><span class="font-medium">Time:</span>
                  {{ course.timeFrom }} - {{ course.timeTo }}</span
                >
              </li>
              <li class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                <span class="text-lg">üë•</span>
                <span
                  ><span class="font-medium">Seats:</span>
                  {{ course.availableSeats }}</span
                >
              </li>
              <li class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                <span class="text-lg">üè∑Ô∏è</span>
                <span
                  ><span class="font-medium">Category:</span>
                  {{ getCategoryText(course.category) }}</span
                >
              </li>
              <li class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                <span class="text-lg">üîÅ</span>
                <span
                  ><span class="font-medium">Online/Repeated:</span>
                  {{ course.onlineRepeated ? "Yes" : "No" }}</span
                >
              </li>
              <li class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                <span class="text-lg">‚öñÔ∏è</span>
                <span
                  ><span class="font-medium">KPI Weight:</span>
                  {{ course.kpiWeight || "Not set" }}</span
                >
              </li>
            </ul>

            <!-- Enroll Button -->
            <div
              *ngIf="canUserEnroll() && currentUser"
              class="mt-6 pt-6 border-t border-gray-200"
            >
              <button
                (click)="enrollInCourse()"
                [disabled]="enrolling"
                class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-medium py-3 px-4 rounded-lg transition-all duration-200 flex items-center justify-center shadow-sm"
              >
                <i *ngIf="enrolling" class="fas fa-spinner fa-spin mr-2"></i>
                <i *ngIf="!enrolling" class="fas fa-user-plus mr-2"></i>
                {{
                  enrolling
                    ? "Enrolling..."
                    : course?.userRegistrationStatusId === 2
                    ? "Re-enroll"
                    : "Enroll in Course"
                }}
              </button>
              <p class="text-xs text-gray-500 mt-3 text-center">
                {{
                  course?.userRegistrationStatusId === 3
                    ? "Your previous enrollment was rejected. You can try again."
                    : "Join this course to start learning"
                }}
              </p>
            </div>

            <!-- Pending Enrollment Message -->
            <div
              *ngIf="
                course?.isUserRegistered &&
                course?.userRegistrationStatusId === 1 &&
                currentUser
              "
              class="mt-6 pt-6 border-t border-gray-200"
            >
              <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <div class="flex items-center">
                  <i class="fas fa-clock text-yellow-600 mr-3 text-lg"></i>
                  <span class="text-sm font-medium text-yellow-800"
                    >Enrollment Pending</span
                  >
                </div>
                <p class="text-xs text-yellow-600 mt-2">
                  Your enrollment is awaiting approval
                </p>
              </div>
            </div>

            <!-- Already Enrolled Message -->
            <div
              *ngIf="
                course?.isUserRegistered &&
                course?.userRegistrationStatusId === 2 &&
                currentUser
              "
              class="mt-6 pt-6 border-t border-gray-200"
            >
              <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <div class="flex items-center">
                  <i
                    class="fas fa-check-circle text-green-600 mr-3 text-lg"
                  ></i>
                  <span class="text-sm font-medium text-green-800"
                    >You are enrolled</span
                  >
                </div>
                <p class="text-xs text-green-600 mt-2">
                  You can access all course materials
                </p>
              </div>
            </div>

            <!-- Rejected Enrollment Message -->
            <div
              *ngIf="
                course?.isUserRegistered &&
                course?.userRegistrationStatusId === 3 &&
                currentUser
              "
              class="mt-6 pt-6 border-t border-gray-200"
            >
              <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <div class="flex items-center">
                  <i class="fas fa-times-circle text-red-600 mr-3 text-lg"></i>
                  <span class="text-sm font-medium text-red-800"
                    >Enrollment Rejected</span
                  >
                </div>
                <p class="text-xs text-red-600 mt-2">
                  Your enrollment was not approved. You can try enrolling again.
                </p>
              </div>
            </div>

            <!-- Login Required Message -->
            <div
              *ngIf="!currentUser"
              class="mt-6 pt-6 border-t border-gray-200"
            >
              <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <div class="flex items-center">
                  <i
                    class="fas fa-exclamation-triangle text-yellow-600 mr-3 text-lg"
                  ></i>
                  <span class="text-sm font-medium text-yellow-800"
                    >Login required</span
                  >
                </div>
                <p class="text-xs text-yellow-600 mt-2">
                  Please log in to enroll in this course
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading State -->
<div
  *ngIf="!course"
  class="min-h-screen bg-gray-50 flex items-center justify-center"
>
  <div class="text-center">
    <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
    <p class="text-gray-600">Loading course details...</p>
  </div>
</div>

<!-- Floating QR Scan Button - Mobile Only -->
<button
  *ngIf="course"
  (click)="scanQR()"
  class="fixed bottom-24 right-6 z-50 md:hidden group"
  aria-label="Scan QR Code"
>
  <!-- Background with gradient -->
  <div class="relative">
    <!-- Main button -->
    <div
      class="w-14 h-14 bg-gradient-to-br from-purple-500 via-blue-500 to-cyan-500 rounded-full shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:scale-110 group-hover:rotate-12 flex items-center justify-center"
    >
      <i class="fas fa-qrcode text-white text-lg"></i>
    </div>

    <!-- Glow effect -->
  </div>

  <!-- Tooltip -->
  <div
    class="absolute right-16 top-1/2 transform -translate-y-1/2 bg-gray-900 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap"
  >
    Scan QR Code
    <div
      class="absolute left-full top-1/2 transform -translate-y-1/2 w-0 h-0 border-l-4 border-l-gray-900 border-t-2 border-t-transparent border-b-2 border-b-transparent"
    ></div>
  </div>
</button>

<!-- QR Scanner Modal -->
<app-qr-scanner
  *ngIf="showQRScanner"
  (scanResult)="onQRScanResult($event)"
  (close)="onQRScannerClose()"
></app-qr-scanner>

<!-- Attendance QR Popup Modal -->
<div
  *ngIf="showAttendanceQRPopup"
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
  (click)="closeAttendanceQRPopup()"
>
  <div
    class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6"
    (click)="$event.stopPropagation()"
  >
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-xl font-bold text-gray-900 flex items-center">
        <i class="fas fa-qrcode text-purple-600 mr-3"></i>
        Attendance QR Code
      </h3>
      <div class="flex items-center gap-3">
        <!-- Auto-reload Toggle -->
        <button
          (click)="toggleQRAutoReload()"
          [class]="
            isAutoReloadEnabled
              ? 'bg-green-100 text-green-700 hover:bg-green-200'
              : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
          "
          class="px-3 py-1 rounded-lg text-sm font-medium transition-colors flex items-center gap-2"
          title="Toggle Auto-reload"
        >
          <i class="fas fa-sync-alt text-xs"></i>
          <span class="text-xs">{{ isAutoReloadEnabled ? "ON" : "OFF" }}</span>
        </button>

        <!-- Close Button -->
        <button
          (click)="closeAttendanceQRPopup()"
          class="text-gray-400 hover:text-gray-600 transition-colors"
        >
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="attendanceQRLoading" class="text-center py-8">
      <div
        class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"
      ></div>
      <p class="text-gray-600">Loading QR code...</p>
    </div>

    <!-- QR Code Content -->
    <div *ngIf="!attendanceQRLoading && attendanceQRData" class="text-center">
      <!-- Manual Reload Button -->
      <div class="mb-4 flex justify-center">
        <button
          (click)="manualReloadQR()"
          [disabled]="attendanceQRLoading"
          class="inline-flex items-center px-4 py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-400 text-white text-sm font-medium rounded-lg transition-colors"
        >
          <i
            *ngIf="attendanceQRLoading"
            class="fas fa-spinner fa-spin mr-2"
          ></i>
          <i *ngIf="!attendanceQRLoading" class="fas fa-sync-alt mr-2"></i>
          {{ attendanceQRLoading ? "Reloading..." : "Reload QR" }}
        </button>
      </div>

      <!-- QR Code Image -->
      <div class="bg-gray-50 rounded-lg p-6 mb-4">
        <img
          *ngIf="
            attendanceQRData.qrCodeUrl ||
            attendanceQRData.qrCode ||
            attendanceQRData.data
          "
          [src]="getQRImageSource()"
          [alt]="'Attendance QR Code for ' + course?.title"
          class="mx-auto max-w-full h-auto"
          style="max-height: 300px"
          (error)="onQRImageError($event)"
        />
        <div *ngIf="!getQRImageSource()" class="text-gray-500 py-8">
          <i class="fas fa-qrcode text-4xl mb-4"></i>
          <p>QR code data available but not in image format</p>
          <pre class="text-xs mt-2 bg-gray-100 p-2 rounded overflow-auto">{{
            attendanceQRData | json
          }}</pre>
        </div>
      </div>

      <!-- Countdown Timer at Bottom -->
      <div *ngIf="isAutoReloadEnabled" class="mb-4 flex justify-center">
        <div
          class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-full shadow-lg"
        >
          <div class="flex items-center gap-3">
            <i class="fas fa-clock text-lg"></i>
            <div class="text-center">
              <div class="text-sm font-medium">Next refresh in</div>
              <div class="text-2xl font-bold">{{ qrCountdown }}s</div>
            </div>
            <div
              class="w-8 h-8 border-2 border-white border-t-transparent rounded-full animate-spin"
            ></div>
          </div>
        </div>
      </div>

      <!-- Course Info -->
      <div class="text-left bg-gray-50 rounded-lg p-4 mb-4">
        <h4 class="font-semibold text-gray-900 mb-2">Course Information</h4>
        <div class="space-y-2 text-sm text-gray-700">
          <div>
            <span class="font-medium">Course:</span> {{ course?.title }}
          </div>
          <div *ngIf="attendanceQRData.courseId">
            <span class="font-medium">Course ID:</span>
            {{ attendanceQRData.courseId }}
          </div>
          <div *ngIf="attendanceQRData.mimeType">
            <span class="font-medium">File Type:</span>
            {{ attendanceQRData.mimeType }}
          </div>
          <div *ngIf="attendanceQRData.size">
            <span class="font-medium">File Size:</span>
            {{ (attendanceQRData.size / 1024).toFixed(1) }} KB
          </div>
          <div *ngIf="attendanceQRData.validUntil">
            <span class="font-medium">Valid Until:</span>
            {{ attendanceQRData.validUntil | date : "medium" }}
          </div>
          <div *ngIf="attendanceQRData.createdAt">
            <span class="font-medium">Generated:</span>
            {{ attendanceQRData.createdAt | date : "medium" }}
          </div>
        </div>
      </div>

      <!-- Instructions -->
      <div class="text-sm text-gray-600 bg-blue-50 rounded-lg p-4">
        <h4 class="font-semibold text-blue-900 mb-2">Instructions</h4>
        <p class="text-blue-800">
          Students can scan this QR code to mark their attendance for this
          course. The QR code should be displayed during class sessions.
        </p>
      </div>
    </div>

    <!-- Error State -->
    <div
      *ngIf="!attendanceQRLoading && !attendanceQRData"
      class="text-center py-8"
    >
      <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
      <p class="text-gray-600">Failed to load QR code</p>
      <button
        (click)="showAttendanceQR()"
        class="mt-4 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors"
      >
        Try Again
      </button>
    </div>

    <!-- Footer -->
    <div class="mt-6 flex justify-end">
      <button
        (click)="closeAttendanceQRPopup()"
        class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg transition-colors"
      >
        Close
      </button>
    </div>
  </div>
</div>

<!-- AI Helper -->
<app-ai-helper></app-ai-helper>

<!-- Course QR Popup Modal -->
<div
  *ngIf="showCourseQRPopup"
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
  (click)="closeCourseQRPopup()"
>
  <div
    class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6"
    (click)="$event.stopPropagation()"
  >
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-xl font-bold text-gray-900 flex items-center">
        <i class="fas fa-qrcode text-indigo-600 mr-3"></i>
        Course QR Code
      </h3>
      <div class="flex items-center gap-3">
        <!-- Auto-reload Toggle -->
        <button
          (click)="toggleCourseQRAutoReload()"
          [class]="
            isAutoReloadEnabled
              ? 'bg-green-100 text-green-700 hover:bg-green-200'
              : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
          "
          class="px-3 py-1 rounded-lg text-sm font-medium transition-colors flex items-center gap-2"
          title="Toggle Auto-reload"
        >
          <i class="fas fa-sync-alt text-xs"></i>
          <span class="text-xs">{{ isAutoReloadEnabled ? "ON" : "OFF" }}</span>
        </button>

        <!-- Close Button -->
        <button
          (click)="closeCourseQRPopup()"
          class="text-gray-400 hover:text-gray-600 transition-colors"
        >
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="courseQRLoading" class="text-center py-8">
      <div
        class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"
      ></div>
      <p class="text-gray-600">Loading QR code...</p>
    </div>

    <!-- QR Code Content -->
    <div *ngIf="!courseQRLoading && courseQRData" class="text-center">
      <!-- Manual Reload Button -->
      <div class="mb-4 flex justify-center">
        <button
          (click)="manualReloadCourseQR()"
          [disabled]="courseQRLoading"
          class="inline-flex items-center px-4 py-2 bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400 text-white text-sm font-medium rounded-lg transition-colors"
        >
          <i *ngIf="courseQRLoading" class="fas fa-spinner fa-spin mr-2"></i>
          <i *ngIf="!courseQRLoading" class="fas fa-sync-alt mr-2"></i>
          {{ courseQRLoading ? "Reloading..." : "Reload QR" }}
        </button>
      </div>

      <!-- QR Code Image -->
      <div class="bg-gray-50 rounded-lg p-6 mb-4">
        <img
          *ngIf="
            courseQRData.qrCodeUrl || courseQRData.qrCode || courseQRData.data
          "
          [src]="getCourseQRImageSource()"
          [alt]="'Course QR Code for ' + course?.title"
          class="mx-auto max-w-full h-auto"
          style="max-height: 300px"
          (error)="onCourseQRImageError($event)"
        />
        <div *ngIf="!getCourseQRImageSource()" class="text-gray-500 py-8">
          <i class="fas fa-qrcode text-4xl mb-4"></i>
          <p>QR code data available but not in image format</p>
          <pre class="text-xs mt-2 bg-gray-100 p-2 rounded overflow-auto">{{
            courseQRData | json
          }}</pre>
        </div>
      </div>

      <!-- Countdown Timer at Bottom -->
      <div *ngIf="isAutoReloadEnabled" class="mb-4 flex justify-center">
        <div
          class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-6 py-3 rounded-full shadow-lg"
        >
          <div class="flex items-center gap-3">
            <i class="fas fa-clock text-lg"></i>
            <div class="text-center">
              <div class="text-sm font-medium">Next refresh in</div>
              <div class="text-2xl font-bold">{{ qrCountdown }}s</div>
            </div>
            <div
              class="w-8 h-8 border-2 border-white border-t-transparent rounded-full animate-spin"
            ></div>
          </div>
        </div>
      </div>

      <!-- Course Info -->
      <div class="text-left bg-gray-50 rounded-lg p-4 mb-4">
        <h4 class="font-semibold text-gray-900 mb-2">Course Information</h4>
        <div class="space-y-2 text-sm text-gray-700">
          <div>
            <span class="font-medium">Course:</span> {{ course?.title }}
          </div>
          <div *ngIf="courseQRData.courseId">
            <span class="font-medium">Course ID:</span>
            {{ courseQRData.courseId }}
          </div>
          <div *ngIf="courseQRData.mimeType">
            <span class="font-medium">File Type:</span>
            {{ courseQRData.mimeType }}
          </div>
          <div *ngIf="courseQRData.size">
            <span class="font-medium">File Size:</span>
            {{ (courseQRData.size / 1024).toFixed(1) }} KB
          </div>
          <div *ngIf="courseQRData.validUntil">
            <span class="font-medium">Valid Until:</span>
            {{ courseQRData.validUntil | date : "medium" }}
          </div>
          <div *ngIf="courseQRData.createdAt">
            <span class="font-medium">Generated:</span>
            {{ courseQRData.createdAt | date : "medium" }}
          </div>
        </div>
      </div>

      <!-- Instructions -->
      <div class="text-sm text-gray-600 bg-indigo-50 rounded-lg p-4">
        <h4 class="font-semibold text-indigo-900 mb-2">Instructions</h4>
        <p class="text-indigo-800">
          This QR code contains course information and can be scanned by
          students to access course details or register for the course.
        </p>
      </div>
    </div>

    <!-- Error State -->
    <div *ngIf="!courseQRLoading && !courseQRData" class="text-center py-8">
      <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
      <p class="text-gray-600">Failed to load QR code</p>
      <button
        (click)="showCourseQR()"
        class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-colors"
      >
        Try Again
      </button>
    </div>

    <!-- Footer -->
    <div class="mt-6 flex justify-end">
      <button
        (click)="closeCourseQRPopup()"
        class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg transition-colors"
      >
        Close
      </button>
    </div>
  </div>
</div>
